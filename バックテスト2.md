## TradingAgents2 バックテスト機能 要件定義書

### 1. 概要

論文「TradingAgents: Multi-Agents LLM Financial Trading Framework」（Xiao et al., 2025）のシミュレーション手法に完全準拠し、o1-previewとgpt-4oを活用した深い思考と速い思考の組み合わせによる、現実的な金融取引会社をシミュレートするバックテスト機能を実現する。

### 2. 機能要件

#### 2.1 データ管理層

##### 2.1.1 価格データ処理
- **必須要件**
  - Tauric TradingDBからのキャッシュデータ取得（論文準拠）
  - Yahoo Finance APIを通じた日次OHLCV取得（フォールバック）
  - 欠損値処理（5営業日未満は線形補間、以上は除外）
  - データ品質検証（価格≤0、全NA列の除外）
  - 再現可能性のためのデータスナップショット管理
  
- **拡張要件**
  - 複数データソース対応（Alpha Vantage, IEX Cloud等）
  - 分足データ対応
  - 配当・株式分割調整

##### 2.1.2 ニュース・SNSデータ処理
- **必須要件**
  - **Finnhub API**：企業ニュース、インサイダーセンチメント、インサイダー取引情報
  - **Google News**：Webスクレイピングによるグローバル・企業固有ニュース
  - **Reddit API**：ソーシャルメディア議論、センチメント分析
  - APIクエリレベルでの時間フィルタリング（`end_date = T`）
  - 取引時間外情報の翌営業日シフト（16:00以降→T+1）
  - 日次センチメントサマリー生成（JSON形式）
  - センチメントスコア正規化（-1〜1）

- **拡張要件**
  - マルチ言語対応（日本語ニュース等）
  - リアルタイムストリーミング対応
  - カスタムセンチメント分析モデル選択

##### 2.1.3 ファンダメンタルデータ
- **必須要件**
  - **SimFin API**：バランスシート、キャッシュフロー計算書、損益計算書
  - **Stockstats**：テクニカル指標計算（RSI、MACD、ボリンジャーバンド、ATR等）
  - 四半期データのロールフォワード処理
  - 公表日ベースのタイムスタンプ管理
  - 欠損期間のNaN設定

##### 2.1.4 ルックアヘッドバイアス排除
- **必須要件**
  - データ参照時の時間境界チェック（`timestamp ≤ T`）
  - エージェント状態の append-only ログ管理
  - オンザフライでのテクニカル指標計算

#### 2.2 エージェント層

##### 2.2.1 マルチエージェント構成
- **必須要件**
  - **アナリスト層**（データ収集・分析）
    - Market Analyst：テクニカル指標分析（RSI, MACD, ボリンジャーバンド等）
    - News Analyst：グローバルニュース・トレンド分析
    - Social Media Analyst：ソーシャルメディア・企業固有ニュース・センチメント分析
    - Fundamentals Analyst：財務諸表・インサイダー取引・企業ファンダメンタルズ分析
  - **リサーチャー層**（投資判断）
    - Bull Researcher：強気の投資論拠構築
    - Bear Researcher：弱気の投資論拠構築
    - Research Manager：ポートフォリオマネージャー兼ディベート司会
  - **リスク評価層**
    - Aggressive Risk Debator：積極的リスクテイク視点
    - Conservative Risk Debator：保守的リスク管理視点
    - Neutral Risk Debator：バランス型リスク評価視点
    - Risk Manager：最終リスク判断
  - **実行層**
    - Trader：最終売買判断（BUY/HOLD/SELL）
  - **LLMモデル使い分け**
    - `deep_think_llm`（o1-preview相当）：マネージャー層用
    - `quick_think_llm`（gpt-4o相当）：アナリスト層用
  - **日本語プロンプト**による分析実行

- **拡張要件**
  - カスタムエージェントのプラグイン機構
  - エージェント構成の動的変更
  - ローカルLLMモデルのサポート

##### 2.2.2 通信プロトコル
- **必須要件**
  - 構造化メッセージ（JSON スキーマ）による通信
  - 役割別データアクセス制限
  - 決定プロセスの追跡可能性
  - **投資ディベート機能**
    - 設定可能なディベートラウンド数（`max_debate_rounds`、デフォルト1回）
    - Bull vs Bear の論拠対決
    - Research Managerによる評価と調停
  - **リスクディスカッション機能**
    - 設定可能なディスカッションラウンド数（`max_risk_discuss_rounds`、デフォルト1回）
    - 3つの視点からのリスク評価
    - Risk Managerによる最終判断
  - LangGraphベースのエージェント間オーケストレーション

##### 2.2.3 決定フローの制御
- **必須要件**
  - **逐次的な意思決定フロー**
    1. データ収集フェーズ：4つのアナリストが順次実行（完了後に次フェーズ）
    2. 分析フェーズ：Bull/Bear リサーチャーがアナリストレポートを基に論拠構築
    3. 投資判断フェーズ：Research Managerがディベートを司会・評価
    4. 取引決定フェーズ：Traderが投資計画に基づき初期判断
    5. リスク評価フェーズ：3つのリスクデベーターが議論
    6. 最終決定フェーズ：Risk Managerが最終取引判断
  - **エージェント間の依存関係**
    - 前段の出力が次段の入力となる厳密な依存関係
    - 各フェーズ完了後のみ次フェーズ開始
  - **情報の非対称性**
    - アナリストは取引判断を知らない（バイアス防止）
    - リサーチャーは取引結果を知らない
    - 各エージェントは自身の役割に必要な情報のみアクセス可能

#### 2.3 取引実行層

##### 2.3.1 売買ロジック
- **必須要件**
  - BUY/SELL/HOLD シグナルの解析
  - **段階的ポジションサイジング（論文準拠）**
    - リスクプロファイル別の資本配分ルール
      - Aggressive：利用可能資本の最大80%
      - Neutral：利用可能資本の最大50%
      - Conservative：利用可能資本の最大30%
    - 信頼度スコアに基づくサイズ調整
      - 高信頼度（0.8以上）：プロファイル上限値
      - 中信頼度（0.5-0.8）：プロファイル上限値の70%
      - 低信頼度（0.5未満）：プロファイル上限値の40%
    - 最小取引単位：$1,000または利用可能資本の10%のいずれか小さい方
    - 既存ポジションとの合算制限：総資本の90%を超えない
  - 分割売買によるリスク管理
    - 初回エントリー：計画ポジションの50%
    - 追加エントリー：価格が有利に動いた場合のみ
    - 部分決済：目標利益の50%達成時に半分決済
  - スリッページ計算（買い：`price * (1 + slippage)`、売り：`price * (1 - slippage)`）

- **拡張要件**
  - ショートセル対応
  - オプション取引対応
  - アルゴリズミック執行戦略

##### 2.3.2 取引コスト
- **必須要件**
  - スリッページモデル
  - 手数料モデル（固定/変動）
  - 市場インパクトコスト
  - 総合的な取引コスト計算（論文準拠）

- **拡張要件**
  - 税金計算
  - 借入コスト（ショート時）
  - 通貨ヘッジコスト

#### 2.4 評価・分析層

##### 2.4.1 パフォーマンス指標
- **必須要件**
  - Total Return / Annualized Return
  - Sharpe Ratio（リスクフリーレート考慮）
  - Sortino Ratio（下方リスク評価）
  - Maximum Drawdown
  - Win Rate / Total Trades
  - Winning Trades / Losing Trades
  - Average Win / Average Loss
  - Profit Factor
  - Volatility（年率換算）
  - Final Portfolio Value
  - **ベンチマーク比較指標**
    - S&P 500 インデックスとの相対パフォーマンス
    - 超過リターン（アルファ）の計算
    - ベータ値（市場連動性）の測定
    - トラッキングエラー（ベンチマークとの乖離度）
    - インフォメーションレシオ（リスク調整後超過リターン）
    - アップ/ダウンキャプチャレシオ
  - **ベンチマーク調整後指標**
    - 相対シャープレシオ（ベンチマーク比）
    - 相対最大ドローダウン
    - 相対ボラティリティ

- **拡張要件**
  - Calmar Ratio（リターン対最大ドローダウン）
  - Jensen's Alpha（CAPM調整後アルファ）
  - Treynor Ratio
  - VaR / CVaR

##### 2.4.2 取引分析
- **必須要件**
  - 取引履歴記録（日時、価格、数量、アクション）
  - 勝率・平均利益/損失計算
  - ポジション保有期間分析

#### 2.5 出力・レポート層

##### 2.5.1 可視化
- **必須要件**
  - 資産推移グラフ
  - 売買シグナル付き価格チャート
  - ドローダウンチャート
  - リターン分布ヒストグラム

- **拡張要件**
  - インタラクティブダッシュボード
  - 3D可視化（複数銘柄の相関等）

##### 2.5.2 ログ・レポート
- **必須要件**
  - 構造化ログ（JSONL形式）
  - 取引ログCSV出力
  - メトリクスJSON保存

### 3. 非機能要件

#### 3.1 パフォーマンス
- **必須要件**
  - Deep Think Mode（o1-preview使用）とFast Mode（gpt-4o使用）の適切な組み合わせ
  - 判断結果キャッシング機構
  - オフラインモード対応（Tauric TradingDBキャッシュ使用）
  - 1銘柄・1年分を適切な時間内で処理（品質優先）

- **拡張要件**
  - 並列処理（複数銘柄同時実行）
  - バッチ処理（複数日の判断を一括取得）
  - GPU活用（ローカルLLM使用時）
  - 処理時間とコストの最適化

#### 3.2 拡張性
- **必須要件**
  - プラグイン可能な戦略設計
  - カスタムエージェント追加機能
  - 外部データソース統合API

#### 3.3 信頼性
- **必須要件**
  - エラーハンドリング（API失敗時のリトライ）
  - データ検証（異常値・欠損値チェック）
  - 再現可能性（`online_tools: false`設定）
  - **メモリシステムによる過去の判断記録**
    - エージェント個別メモリ
      - アナリスト：自身の分析精度履歴（予測vs実績）
      - リサーチャー：投資論拠の成功/失敗パターン
      - トレーダー：取引判断の結果追跡
      - リスクマネージャー：リスク評価の妥当性検証
    - グローバルメモリ
      - 市場環境パターンの学習（強気/弱気相場の特徴）
      - 銘柄別の取引履歴と特性
      - 重要イベント（決算、経済指標）の影響度
    - メモリ構造
      - 短期メモリ：直近10取引の詳細情報
      - 長期メモリ：集約された統計情報とパターン
  - **リフレクション機能による学習メカニズム**
    - 取引完了後の自動振り返り
      - 各エージェントが自身の判断を評価
      - 成功/失敗要因の構造化分析
      - 改善提案の生成と記録
    - 定期的な総合レビュー（週次/月次）
      - 全エージェントのパフォーマンス評価
      - システム全体の改善点抽出
    - 学習内容の適用
      - 次回判断時に過去の学習を参照
      - 類似パターン検出による警告機能
  - 初期資本金設定（デフォルト: $10,000）
  - リスクフリーレート設定（デフォルト: 2%）

### 4. 実装上の考慮事項

#### 4.1 現在の課題と改善案
- **エージェント協調**: 論文に基づく深い思考と速い思考の最適な組み合わせ
- **データ再現性**: Tauric TradingDBキャッシュの完全活用
- **取引執行**: 論文準拠の段階的ポジションサイジング実装

#### 4.2 実装上の重要な制約
- **必須要件**
  - **決定論的な実行環境**
    - 乱数シードの固定（`random_seed: 42`）
    - NumPy/Pandas等の乱数シード統一
    - LLMの温度パラメータ固定（`temperature: 0`）
  - **API呼び出し順序の制御**
    - データ取得の順序を厳密に固定
    - 並列処理時の結果集約順序の保証
    - タイムスタンプによる厳密な順序管理
  - **タイムゾーンの統一**
    - 全データをUTCで統一管理
    - 市場時間の変換ロジック明確化
    - サマータイム対応の自動化
  - **データ整合性の保証**
    - トランザクション単位でのデータ更新
    - 読み取り一貫性の保証
    - データバージョン管理
  - **監査証跡（Audit Trail）**
    - 全ての判断プロセスの記録
    - 入力データのスナップショット保存
    - 判断根拠の構造化保存
    - タイムスタンプ付き実行ログ

#### 4.3 優先順位
1. **Phase 1**: 論文準拠の完全実装（段階的売買、包括的コストモデル、マルチエージェント協調）
2. **Phase 2**: パフォーマンス最適化とスケーラビリティ向上
3. **Phase 3**: リアルタイムデータ統合・ライブトレード対応

### 5. テスト要件

#### 5.1 単体テスト
- データ処理ロジックの正確性
- エージェント間通信の整合性
- メトリクス計算の妥当性

#### 5.2 統合テスト
- エンドツーエンドのバックテストフロー
- 複数銘柄ポートフォリオテスト
- 長期間データでのストレステスト

#### 5.3 検証項目
- ルックアヘッドバイアスの不在証明
- パフォーマンス指標の他ツールとの比較検証
- エージェント判断の説明可能性確認

### 6. 今後の拡張計画

1. **マルチアセット対応**: 株式以外の資産クラス（債券、商品、暗号資産）
2. **高頻度取引対応**: ティックデータ、マイクロ秒単位の判断
3. **強化学習統合**: バックテスト結果を用いたエージェント最適化
4. **クラウド対応**: 分散処理による大規模バックテスト

この要件定義は、論文「TradingAgents: Multi-Agents LLM Financial Trading Framework」の手法に完全準拠し、実際の金融取引会社の意思決定プロセスを忠実に再現することを最優先としています。特に、o1-previewによる深い分析とgpt-4oによる迅速な判断の組み合わせ、段階的ポジションサイジング、包括的な取引コストモデルなど、論文の核心的要素を必須要件として定義しています。 