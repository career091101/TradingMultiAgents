# 分析完了通知機能 要件定義書

## 1. 概要

### 1.1 目的
TradingAgentsの分析が完了した際に、ユーザーに自動的に通知を送信する機能を実装し、ユーザーが分析完了を待つ必要をなくす。

### 1.2 背景
- 現状：ユーザーは分析完了までブラウザを開いて待機する必要がある
- 課題：分析に時間がかかる場合（5-30分）、ユーザーの時間が拘束される
- 解決：バックグラウンドで分析を実行し、完了時に通知を送信

## 2. 機能要件

### 2.1 通知チャネル

#### 必須機能（Phase 1）
1. **ブラウザ通知（Web Push Notification）**
   - デスクトップ/モバイルブラウザでのプッシュ通知
   - 通知クリックで結果ページに直接遷移
   - オフライン時の通知保存

2. **メール通知**
   - 分析完了メールの送信
   - 結果サマリーを含む
   - 結果へのダイレクトリンク

#### 追加機能（Phase 2）
3. **Slack通知**
   - Slack Webhook経由での通知
   - チャンネル/DM選択可能
   - リッチフォーマット対応

4. **Discord通知**
   - Discord Webhook対応
   - 埋め込み（Embed）形式

5. **LINE通知**
   - LINE Notify API統合
   - 日本ユーザー向け

6. **モバイルアプリ通知**
   - iOS/Android プッシュ通知
   - Firebase Cloud Messaging使用

### 2.2 通知内容

#### 基本情報
```json
{
  "notification_type": "analysis_complete",
  "ticker": "AAPL",
  "analysis_date": "2025-01-17",
  "status": "completed",
  "completion_time": "2025-01-17T14:30:00Z",
  "duration_minutes": 12,
  "result_url": "https://app.tradingagents.com/results/AAPL/2025-01-17"
}
```

#### 詳細情報（オプション）
```json
{
  "summary": {
    "recommendation": "BUY",
    "confidence": 0.85,
    "key_points": [
      "強気相場の継続",
      "ファンダメンタルズ良好",
      "テクニカル指標ポジティブ"
    ],
    "risk_level": "MEDIUM"
  },
  "agents_completed": {
    "market_analyst": true,
    "news_analyst": true,
    "social_analyst": true,
    "fundamentals_analyst": true
  }
}
```

### 2.3 通知設定

#### ユーザー設定項目
1. **通知の有効/無効**
   - グローバル設定
   - チャネル別設定

2. **通知タイミング**
   - 即時通知
   - バッチ通知（時間指定）
   - サイレント時間帯設定

3. **通知内容レベル**
   - 最小限（完了通知のみ）
   - 標準（基本情報含む）
   - 詳細（サマリー含む）

4. **通知条件**
   - 全ての分析
   - 特定ティッカーのみ
   - 特定の結果（BUY/SELL推奨時のみ等）

## 3. 技術要件

### 3.1 アーキテクチャ

```
┌─────────────┐     ┌──────────────┐     ┌─────────────────┐
│   WebUI     │────▶│ Notification │────▶│ Notification    │
│             │     │   Service    │     │ Providers       │
└─────────────┘     └──────────────┘     └─────────────────┘
                            │                      │
                            ▼                      ▼
                    ┌──────────────┐      ┌──────────────┐
                    │ Queue/Redis  │      │ Email/Slack/ │
                    │              │      │ Push/etc     │
                    └──────────────┘      └──────────────┘
```

### 3.2 実装技術

#### ブラウザ通知
- **Service Worker**: オフライン対応、バックグラウンド処理
- **Push API**: W3C標準のプッシュ通知
- **Notification API**: 通知表示

#### バックエンド
- **Celery**: 非同期タスク処理
- **Redis**: メッセージキュー、通知ステート管理
- **WebSocket**: リアルタイム通信（オプション）

#### 通知プロバイダー
- **SendGrid/AWS SES**: メール送信
- **Firebase Cloud Messaging**: モバイルプッシュ
- **Webhook**: Slack/Discord統合

### 3.3 データモデル

```python
# 通知設定
class NotificationSettings(BaseModel):
    user_id: str
    enabled: bool = True
    channels: Dict[str, ChannelSettings]
    
class ChannelSettings(BaseModel):
    enabled: bool
    config: Dict[str, Any]  # チャネル固有の設定
    
# 通知履歴
class NotificationHistory(BaseModel):
    id: str
    user_id: str
    analysis_id: str
    channel: str
    status: Literal["pending", "sent", "failed", "read"]
    sent_at: Optional[datetime]
    read_at: Optional[datetime]
    error: Optional[str]
```

## 4. UI/UX要件

### 4.1 設定画面

```
📢 通知設定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔔 通知を有効にする [ON/OFF]

📧 メール通知
  ├─ 有効 [✓]
  ├─ メールアドレス: user@example.com
  └─ 通知レベル: [最小限|標準|詳細]

💬 Slack通知
  ├─ 有効 [✓]
  ├─ Webhook URL: ****
  └─ チャンネル: #trading-alerts

🌐 ブラウザ通知
  ├─ 有効 [✓]
  └─ 許可状態: [許可済み|ブロック|要求]

⏰ 通知スケジュール
  ├─ 即時通知 [ON]
  └─ サイレント時間: 22:00 - 07:00

🎯 通知条件
  ├─ 全ての分析 [✓]
  ├─ BUY推奨時のみ [ ]
  └─ 特定ティッカー: [AAPL, MSFT]
```

### 4.2 通知許可フロー

1. **初回アクセス時**
   ```
   ┌────────────────────────────────┐
   │ 🔔 通知を有効にしますか？       │
   │                                │
   │ 分析完了時に通知を受け取れます │
   │                                │
   │ [今すぐ有効] [後で] [詳細]    │
   └────────────────────────────────┘
   ```

2. **権限リクエスト**
   - ブラウザ標準の許可ダイアログ
   - 許可後の確認メッセージ
   - 拒否時の代替案提示

### 4.3 通知表示

#### ブラウザ通知
```
┌─────────────────────────────┐
│ 📈 分析完了 - AAPL          │
│                             │
│ 推奨: BUY (信頼度: 85%)     │
│ 分析時間: 12分              │
│                             │
│ [結果を見る] [閉じる]       │
└─────────────────────────────┘
```

#### メール通知
```
件名: [TradingAgents] AAPL分析完了 - BUY推奨

本文:
分析が完了しました。

ティッカー: AAPL
分析日: 2025-01-17
推奨: BUY
信頼度: 85%

主要ポイント:
• 強気相場の継続
• ファンダメンタルズ良好
• テクニカル指標ポジティブ

詳細な結果はこちら:
https://app.tradingagents.com/results/AAPL/2025-01-17

---
TradingAgents
```

## 5. セキュリティ要件

### 5.1 認証・認可
- 通知送信前のユーザー認証
- トークンベースの通知配信
- Webhook URLの暗号化保存

### 5.2 プライバシー
- 通知内容の最小化オプション
- 個人情報の除外
- GDPR/個人情報保護法準拠

### 5.3 レート制限
- ユーザー毎の通知数制限
- スパム防止機構
- 異常検知とアラート

## 6. パフォーマンス要件

### 6.1 レスポンス時間
- 分析完了から通知送信まで: < 5秒
- プッシュ通知配信: < 10秒
- メール配信: < 30秒

### 6.2 スケーラビリティ
- 同時通知数: 1,000件/秒
- キュー処理能力: 10,000件/分
- 通知履歴保存: 90日間

### 6.3 信頼性
- 通知配信成功率: > 99%
- リトライ機構: 3回まで
- フォールバック: メール→Slack→ログ

## 7. 実装計画

### Phase 1: 基本実装（2週間）
1. **Week 1**
   - 通知サービスの基本構造
   - メール通知実装
   - 設定画面UI

2. **Week 2**
   - ブラウザ通知実装
   - Service Worker設定
   - 基本的なテスト

### Phase 2: 拡張実装（2週間）
3. **Week 3**
   - Slack/Discord連携
   - 通知履歴機能
   - 詳細設定オプション

4. **Week 4**
   - パフォーマンス最適化
   - セキュリティ強化
   - 統合テスト

### Phase 3: 高度な機能（オプション）
- モバイルアプリ通知
- LINE通知
- カスタム通知条件
- 機械学習による通知最適化

## 8. テスト計画

### 8.1 単体テスト
- 通知サービスロジック
- 各通知チャネル
- 設定管理

### 8.2 統合テスト
- エンドツーエンド通知フロー
- 複数チャネル同時送信
- エラーハンドリング

### 8.3 負荷テスト
- 大量通知の同時送信
- キューのスループット
- システム全体の安定性

## 9. 監視・運用

### 9.1 メトリクス
- 通知送信数/成功率
- 配信遅延時間
- エラー率とタイプ

### 9.2 アラート
- 配信失敗率 > 5%
- キュー滞留 > 1,000件
- サービス停止検知

### 9.3 ログ
- 全通知の送信ログ
- エラー詳細
- ユーザーアクション

## 10. 今後の拡張可能性

### 10.1 AI活用
- 最適な通知タイミングの学習
- ユーザー別の通知内容最適化
- 異常値検出時の自動通知

### 10.2 連携強化
- 他の金融アプリとの連携
- カレンダー連携
- タスク管理ツール連携

### 10.3 高度な分析
- 通知効果の分析
- ユーザーエンゲージメント向上
- A/Bテスト機能

---

*作成日: 2025-01-17*
*バージョン: 1.0*
*作成者: TradingAgents Team*