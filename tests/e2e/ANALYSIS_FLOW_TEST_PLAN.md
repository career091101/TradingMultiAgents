# TradingAgents WebUI 完全分析フローテスト計画

## 1. テスト概要

### 目的
WebUIの完全な分析フロー（設定→実行→待機→結果確認）を研究深度1-5で実行し、各深度での処理時間、進捗表示、結果生成を検証する。

### テスト範囲
- 研究深度: 1, 3, 5（代表値）
- 対象銘柄: SPY（流動性が高く安定したデータ取得が期待できる）
- アナリスト: 総合分析プリセット（全4アナリスト）
- 実行環境: ローカル環境（APIキー設定済み）

## 2. 研究深度別の処理時間推定

| 研究深度 | 推定処理時間 | タイムアウト設定 | 備考 |
|---------|------------|----------------|------|
| 深度1 | 11分 | 15分 | クイック分析、1ラウンド議論 |
| 深度3 | 29分 | 35分 | 標準分析、3ラウンド議論 |
| 深度5 | 47分 | 60分 | 詳細分析、5ラウンド議論 |

## 3. テスト戦略

### 3.1 段階的アプローチ
```
Phase 1: 深度1でのクイックテスト（15分）
  ↓ 成功確認
Phase 2: 深度3での標準テスト（35分）
  ↓ 成功確認
Phase 3: 深度5での詳細テスト（60分）
```

### 3.2 並列実行の回避
- 各深度のテストは順次実行（リソース競合防止）
- API制限への配慮（レート制限回避）

### 3.3 待機時間最適化戦略

#### アダプティブ待機
```python
# 進捗ベースの動的待機
async def wait_for_completion(page, depth):
    base_timeout = {1: 15*60, 3: 35*60, 5: 60*60}[depth]
    
    # 10秒間隔で進捗をチェック
    start_time = time.time()
    last_progress = 0
    stall_count = 0
    
    while (time.time() - start_time) < base_timeout:
        current_progress = await get_progress(page)
        
        if current_progress >= 100:
            return True
            
        if current_progress == last_progress:
            stall_count += 1
            if stall_count > 30:  # 5分間進捗なし
                return False
        else:
            stall_count = 0
            
        last_progress = current_progress
        await asyncio.sleep(10)
```

## 4. 詳細テストシナリオ

### シナリオ1: 深度1 - クイック分析フロー
```yaml
テストID: FLOW-001
目的: 最小構成での完全フロー動作確認
手順:
  1. 設定入力:
     - ティッカー: SPY
     - 研究深度: 1
     - アナリスト: 総合分析プリセット
  2. 分析実行:
     - 実行ボタンクリック
     - 進捗バー表示確認
  3. 待機フェーズ:
     - 最大15分待機
     - 10秒間隔で進捗確認
     - エージェント別ステータス監視
  4. 結果確認:
     - 自動遷移または手動遷移
     - 各レポートタブの確認
     - サマリー内容の検証
検証項目:
  - [ ] 11分±3分で完了
  - [ ] 全エージェントの完了確認
  - [ ] 7つのレポートファイル生成
  - [ ] エラーなし
```

### シナリオ2: 深度3 - 標準分析フロー
```yaml
テストID: FLOW-002
目的: 実用的な設定での完全フロー検証
手順:
  1. 設定入力:
     - ティッカー: SPY
     - 研究深度: 3
     - アナリスト: 総合分析プリセット
  2. 分析実行と監視:
     - 実行開始時刻記録
     - 各エージェント完了時刻記録
  3. 進捗詳細確認:
     - Market Analyst (20%)
     - Social Analyst (40%)
     - News Analyst (60%)
     - Fundamentals Analyst (80%)
     - Research Team (85%)
     - Trader (90%)
     - Portfolio Manager (95%)
  4. 結果検証:
     - 議論ラウンド数確認（3ラウンド）
     - レポート品質チェック
     - 投資判断の一貫性
検証項目:
  - [ ] 29分±5分で完了
  - [ ] 進捗表示の正確性
  - [ ] 中間結果の保存
  - [ ] メモリ使用量の安定性
```

### シナリオ3: 深度5 - 詳細分析フロー
```yaml
テストID: FLOW-003
目的: 最大負荷での安定性とパフォーマンス検証
手順:
  1. リソース監視開始:
     - CPU使用率
     - メモリ使用量
     - ディスクI/O
  2. 分析実行:
     - 深度5設定
     - 詳細ログ有効化
  3. 長時間監視:
     - 5分間隔でスクリーンショット
     - エラー発生時の自動キャプチャ
     - APIレート制限の監視
  4. 完全性確認:
     - 5ラウンドの議論ログ
     - 全レポートの内容量
     - 最終判断の根拠
検証項目:
  - [ ] 60分以内に完了
  - [ ] タイムアウトなし
  - [ ] 全データの整合性
  - [ ] リソース枯渇なし
```

## 5. 結果検証方法

### 5.1 自動検証項目
```python
async def verify_analysis_results(page, ticker, depth):
    # 1. ファイル存在確認
    expected_files = [
        "market_report.md",
        "sentiment_report.md", 
        "news_report.md",
        "fundamentals_report.md",
        "investment_plan.md",
        "trader_investment_plan.md",
        "final_trade_decision.md"
    ]
    
    # 2. レポート内容検証
    - 各レポートに必須セクションが含まれているか
    - 文字数が適切か（深度に応じた詳細度）
    - エラーメッセージが含まれていないか
    
    # 3. サマリー表示検証
    - キーポイントの抽出
    - 推奨アクションの明確性
    - リスク要因の記載
```

### 5.2 手動確認項目
- レポートの論理的一貫性
- 分析の深さ（深度に応じた差異）
- 視覚的表現の適切性

## 6. エラーハンドリング

### 6.1 想定されるエラーケース
1. **API制限エラー**
   - 自動リトライ（60秒待機）
   - 最大3回まで再試行

2. **タイムアウトエラー**
   - 部分的な結果の保存確認
   - エラーログの収集

3. **メモリ不足**
   - ブラウザ再起動
   - テスト継続可否判断

### 6.2 リカバリー戦略
```python
async def handle_analysis_error(page, error_type):
    if error_type == "api_limit":
        await asyncio.sleep(60)
        return await retry_analysis(page)
    elif error_type == "timeout":
        return await check_partial_results(page)
    elif error_type == "memory":
        await restart_browser()
        return False
```

## 7. テスト実行スケジュール

### 推奨実行順序
1. **Day 1 Morning**: 深度1テスト（15分 × 3回 = 45分）
2. **Day 1 Afternoon**: 深度3テスト（35分 × 2回 = 70分）
3. **Day 2**: 深度5テスト（60分 × 1回）

### CI/CD統合時の考慮
- 深度1のみを通常のCIで実行
- 深度3,5は夜間バッチまたは週次実行
- 並列実行は避ける

## 8. 成功基準

### 必須要件
- [ ] 全深度でエラーなく完了
- [ ] 推定時間の±20%以内で完了
- [ ] 全レポートファイルの生成
- [ ] 結果の論理的一貫性

### 品質指標
- 進捗表示の精度: 95%以上
- UI応答性: 常に3秒以内
- メモリリーク: なし
- エラー率: 5%未満

## 9. 実装優先順位

1. **Phase 1**: 基本フロー実装（深度1）
2. **Phase 2**: 進捗監視の高度化
3. **Phase 3**: エラーハンドリング強化
4. **Phase 4**: パフォーマンス最適化
5. **Phase 5**: 完全自動化とレポート生成

## 10. リスクと対策

| リスク | 影響度 | 対策 |
|-------|--------|------|
| API制限到達 | 高 | レート制限監視、バックオフ戦略 |
| 長時間実行による不安定性 | 中 | 定期的な状態保存、チェックポイント |
| 並列実行による競合 | 高 | 排他制御、順次実行の徹底 |
| ネットワーク断絶 | 中 | 自動リトライ、部分結果保存 |